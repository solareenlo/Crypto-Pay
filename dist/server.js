!function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(s,o,function(t){return e[t]}.bind(null,o));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=8)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("passport")},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(23)),n=s(r(6)),i=s(r(0)),a=new i.default.Schema({email:{type:String,unique:!0},password:String,passwordResetToken:String,passwordResetExpires:Date,largeCount:Number,middleCount:Number,smallCount:Number,customerNumber:Number,extPubKey:Array,facebook:String,twitter:String,tokens:Array,profile:{name:String,gender:String,location:String,website:String,picture:String}},{timestamps:!0});a.pre("save",function(e){const t=this;if(!t.isModified("password"))return e();o.default.genSalt(10,(r,s)=>{if(r)return e(r);o.default.hash(t.password,s,void 0,(r,s)=>{if(r)return e(r);t.password=s,e()})})}),a.methods.comparePassword=function(e,t){o.default.compare(e,this.password,(e,r)=>{t(e,r)})},a.methods.gravatar=function(e){if(e||(e=200),!this.email)return`https://gravatar.com/avatar/?s=${e}&d=retro`;return`https://gravatar.com/avatar/${n.default.createHash("md5").update(this.email).digest("hex")}?s=${e}&d=retro`};const u=i.default.model("User",a);t.default=u},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("crypto")},function(e,t,r){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=r(24),n=s(r(25));t.extPubkeys=[process.env.EXT_PUB_KEY_BASE58_1,process.env.EXT_PUB_KEY_BASE58_2,process.env.EXT_PUB_KEY_BASE58_3],t.generateChildPubkeyBuffer=function(e,t){return n.fromBase58(e,o.networks.testnet).derive(t).publicKey},t.generateChildPubkeyBase58=function(e,t){return n.fromBase58(e,o.networks.testnet).derive(t).toBase58()},t.generateMultisigAddress=function(e,t){return o.payments.p2sh({network:o.networks.testnet,redeem:o.payments.p2wsh({network:o.networks.testnet,redeem:o.payments.p2ms({network:o.networks.testnet,m:e,pubkeys:t})})}).address}},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(3)),n=s(r(4));s(r(9));n.default.config({path:".env.example"});const i=s(r(10));i.default.use((e,t,r,s)=>{console.error(e),r.status(500).send("Server Error")});const a=i.default.listen(i.default.get("port"),()=>{console.log("%s http://localhost:%d で動いています.",o.default.green("✓"),i.default.get("port")),console.log("%s %sモードです.",o.default.green("✓"),i.default.get("env")),console.log("%s CTRL-C で停止します.",o.default.green("✓"))});t.default=a},function(e,t){e.exports=require("errorhandler")},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=s(r(11)),i=s(r(3)),a=s(r(12)),u=s(r(4)),l=s(r(13)),c=s(r(14)),d=s(r(15)),f=s(r(16)),p=s(r(17)),m=s(r(18)),h=s(r(0)),g=s(r(19)),y=s(r(1)),b=s(r(20)),_=m.default(d.default);u.default.config({path:".env.example"});const v=o(r(21)),w=o(r(22)),k=o(r(26)),S=r(29),E=l.default();h.default.set("useFindAndModify",!1),h.default.set("useCreateIndex",!0),h.default.set("useNewUrlParser",!0),h.default.connect(process.env.MONGODB_URI||"mongodb://localhost:27017/crypto-pay"),h.default.connection.on("error",e=>{console.error(e),console.log("%s MongoDB connection error. Please make sure MongoDB is running.",i.default.red("✗")),process.exit()}),E.set("port",process.env.PORT||3e3),E.set("views",b.default.join(__dirname,"../views")),E.set("view engine","pug"),E.use(a.default()),E.use(g.default("dev")),E.use(n.default.json()),E.use(n.default.urlencoded({extended:!0})),E.use(f.default()),E.use(d.default({resave:!0,saveUninitialized:!0,secret:process.env.SESSION_SECRET,cookie:{maxAge:12096e5},store:new _({url:process.env.MONGODB_URI||"mongodb://localhost:27017/crypto-pay",autoReconnect:!0})})),E.use(y.default.initialize()),E.use(y.default.session()),E.use(c.default()),E.use(p.default.xframe("SAMEORIGIN")),E.use(p.default.xssProtection(!0)),E.disable("x-powered-by"),E.use((e,t,r)=>{t.locals.user=e.user,r()}),E.use((e,t,r)=>{e.user||"/login"===e.path||"/signup"===e.path||e.path.match(/^\/auth/)||e.path.match(/\./)?e.user&&"/account"===e.path&&(e.session.returnTo=e.originalUrl):e.session.returnTo=e.originalUrl,r()}),E.use("/",l.default.static(b.default.join(__dirname,"public"),{maxAge:315576e5})),E.get("/",w.home),E.get("/login",k.getLogin),E.post("/login",k.postLogin),E.get("/logout",k.logout),E.get("/forgot",k.getForgot),E.post("/forgot",k.postForgot),E.get("/reset/:token",k.getReset),E.post("/reset/:token",k.postReset),E.get("/signup",k.getSignup),E.post("/signup",k.postSignup),E.get("/contact",v.getContact),E.post("/contact",v.postContact),E.get("/account",S.isAuthenticated,k.getAccount),E.post("/account/profile",S.isAuthenticated,k.postUpdateProfile),E.post("/account/password",S.isAuthenticated,k.postUpdatePassword),E.post("/account/delete",S.isAuthenticated,k.postDeleteAccount),E.get("/account/unlink/:provider",S.isAuthenticated,k.getOauthUnlink),E.get("/bitcoin",w.getPayBitcoin),E.put("/bitcoin",w.putPizzaCount),E.get("/others",w.getPayOthers),E.get("/auth/facebook",y.default.authenticate("facebook",{scope:["email","public_profile"]})),E.get("/auth/facebook/callback",y.default.authenticate("facebook",{failureRedirect:"/login"}),(e,t)=>{t.redirect(e.session.returnTo||"/")}),E.get("/auth/twitter",y.default.authenticate("twitter")),E.get("/auth/twitter/callback",y.default.authenticate("twitter",{failureRedirect:"/login"}),(e,t)=>{t.redirect(e.session.returnTo||"/")}),t.default=E},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-flash")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("express-validator")},function(e,t){e.exports=require("lusca")},function(e,t){e.exports=require("connect-mongo")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(5));t.getContact=((e,t)=>{const r=!e.user;t.render("contact",{title:"お問合せ",unknownUser:r})}),t.postContact=((e,t)=>{let r,s;e.user||(e.check("name").not().isEmpty().withMessage("お名前をお書きください."),e.check("email").isEmail().withMessage("メールアドレスが無効です.")),e.check("message").notEmpty().withMessage("ご用件をお書きください");const n=e.validationErrors();if(n)return e.flash("errors",n),t.redirect("/contact");e.user?(r=e.user.profile.name||"",s=e.user.email):(r=e.body.name,s=e.body.email);let i=o.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD}});const a={to:"your@email.com",from:`${r} <${s}>`,subject:"Contact Form | Crypto Pay",text:e.body.message};return i.sendMail(a).then(()=>{e.flash("success",{msg:"Email has been sent successfully!"}),t.redirect("/contact")}).catch(t=>"self signed certificate in certificate chain"===t.message?(console.log("WARNING: Self signed certificate in certificate chain. Retrying with the self signed certificate. Use a valid certificate if in production."),(i=o.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD},tls:{rejectUnauthorized:!1}})).sendMail(a)):(console.log("ERROR: Could not send contact email after security downgrade.\n",t),e.flash("errors",{msg:"Error sending the message. Please try again shortly."}),!1)).then(r=>{if(r)return e.flash("success",{msg:"Email has been sent successfully!"}),t.redirect("/contact")}).catch(r=>(console.log("ERROR: Could not send contact email.\n",r),e.flash("errors",{msg:"Error sending the message. Please try again shortly."}),t.redirect("/contact")))})},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(2)),n=r(7);t.home=((e,t)=>{t.render("home",{title:"ホーム"})}),t.getPayBitcoin=((e,t)=>{if(!e.user)return t.redirect("/");const r={price:[.005,.003,.001],count:[0,0,0],amount:[0,0,0],address:["large","middle","small"]},{id:s}=e.user;o.default.find({_id:s},(e,s)=>{if(e)t.status(500);else{t.status(200),r.count[0]=s[0].largeCount,r.count[1]=s[0].middleCount,r.count[2]=s[0].smallCount;for(let e=0;e<3;e++){r.amount[e]=r.price[e]*r.count[e];const t=[];for(let r=0;r<3;r++)t.push(n.generateChildPubkeyBase58(s[0].extPubKey[r],e));const o=[];for(let s=0;s<3;s++)o.push(n.generateChildPubkeyBuffer(t[s],Number(r.count[e])));r.address[e]=n.generateMultisigAddress(3,o)}t.render("pay/bitcoin",{title:"Bitcoin Pay",tbtc:r})}})}),t.putPizzaCount=((e,t)=>{const{id:r}=e.user,s=e.body.data.count,i=e.body.data.size;0==i?o.default.findById(r,(e,a)=>{e&&t.status(500).send(),(a.largeCount>=0&&1==s||a.largeCount>0&&-1==s)&&o.default.findByIdAndUpdate(r,{$inc:{largeCount:s}},e=>{e&&t.status(500).send(),o.default.find({_id:r},(e,r)=>{e&&t.status(500).send();const s=[];for(let e=0;e<3;e++)s.push(n.generateChildPubkeyBase58(r[0].extPubKey[e],i));const o=[];for(let e=0;e<3;e++)o.push(n.generateChildPubkeyBuffer(s[e],Number(r[0].largeCount)));const a={address:`https://chart.apis.google.com/chart?cht=qr&chs=300x300&chl=bitcoin:${n.generateMultisigAddress(3,o)}?amount=${.005*r[0].largeCount}`,count:r[0].largeCount};t.status(200).send(a)})})}):1==i?o.default.findById(r,(e,a)=>{e&&t.status(500).send(),(a.middleCount>=0&&1==s||a.middleCount>0&&-1==s)&&o.default.findByIdAndUpdate(r,{$inc:{middleCount:s}},e=>{e&&t.status(500).send(),o.default.find({_id:r},(e,r)=>{e&&t.status(500).send();const s=[];for(let e=0;e<3;e++)s.push(n.generateChildPubkeyBase58(r[0].extPubKey[e],i));const o=[];for(let e=0;e<3;e++)o.push(n.generateChildPubkeyBuffer(s[e],Number(r[0].middleCount)));const a={address:`https://chart.apis.google.com/chart?cht=qr&chs=300x300&chl=bitcoin:${n.generateMultisigAddress(3,o)}?amount=${.003*r[0].middleCount}`,count:r[0].middleCount};t.status(200).send(a)})})}):2==i&&o.default.findById(r,(e,a)=>{e&&t.status(500).send(),(a.smallCount>=0&&1==s||a.smallCount>0&&-1==s)&&o.default.findByIdAndUpdate(r,{$inc:{smallCount:s}},e=>{e&&t.status(500).send(),o.default.find({_id:r},(e,r)=>{e&&t.status(500).send();const s=[];for(let e=0;e<3;e++)s.push(n.generateChildPubkeyBase58(r[0].extPubKey[e],i));const o=[];for(let e=0;e<3;e++)o.push(n.generateChildPubkeyBuffer(s[e],Number(r[0].smallCount)));const a={address:`https://chart.apis.google.com/chart?cht=qr&chs=300x300&chl=bitcoin:${n.generateMultisigAddress(3,o)}?amount=${.001*r[0].smallCount}`,count:r[0].smallCount};t.status(200).send(a)})})})}),t.getPayOthers=((e,t)=>{t.render("pay/others",{title:"Others Pay"})})},function(e,t){e.exports=require("bcrypt-nodejs")},function(e,t){e.exports=require("bitcoinjs-lib")},function(e,t){e.exports=require("bip32")},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(6)),n=s(r(5)),i=s(r(1)),a=r(27),u=s(r(2)),l=s(r(28)),c=r(7),d=a.promisify(o.default.randomBytes);t.getLogin=((e,t)=>{if(e.user)return t.redirect("/");t.render("account/login",{title:"ログイン"})}),t.postLogin=((e,t,r)=>{e.assert("email","無効なメールアドレスです.").isEmail(),e.assert("password","パスワードを空白にすることはできません.").notEmpty(),e.sanitize("email").normalizeEmail({gmail_remove_dots:!1});const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("/login");i.default.authenticate("local",(s,o,n)=>s?r(s):o?void e.logIn(o,s=>{if(s)return r(s);e.flash("success",{msg:"ログインに成功しました."}),t.redirect(e.session.returnTo||"/")}):(e.flash("errors",n),t.redirect("/login")))(e,t,r)}),t.logout=((e,t)=>{e.logout(),e.session.destroy(r=>{r&&console.log("Error : Failed to destroy the session during logout.",r),e.user=void 0,t.redirect("/")})}),t.getSignup=((e,t)=>{if(e.user)return t.redirect("/");t.render("account/signup",{title:"アカウント作成"})}),t.postSignup=((e,t,r)=>{e.assert("email","無効なメールアドレスです.").isEmail(),e.assert("password","パスワードは4文字以上にしてください.").len({min:4}),e.assert("confirmPassword","パスワードが一致しません.").equals(e.body.password),e.sanitize("email").normalizeEmail({gmail_remove_dots:!1});const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("/signup");l.default.findOne({name:"sola"},(e,t)=>{if(e)return r(e);if(t)console.log("Counter exist.");else{new l.default({name:"sola",customerCount:0}).save(e=>{if(e)return r(e)})}});const o=new u.default({email:e.body.email,password:e.body.password,largeCount:0,middleCount:0,smallCount:0,customerNumber:0,extPubKey:["a","b","c"]});u.default.findOne({email:e.body.email},(s,n)=>s?r(s):n?(e.flash("errors",{msg:"このメールアドレスのアカウントはすでに存在しています."}),t.redirect("/signup")):void l.default.findOneAndUpdate({name:"sola"},{$inc:{customerCount:1}},{new:!0},(s,n)=>{if(s)return r(s);o.customerNumber=Number(n.customerCount);for(let e=0;e<3;e++)o.extPubKey[e]=c.generateChildPubkeyBase58(c.extPubkeys[e],Number(o.customerNumber));o.save(s=>{if(s)return r(s);e.logIn(o,e=>{if(e)return r(e);t.redirect("/")})})}))}),t.getForgot=((e,t)=>{if(e.isAuthenticated())return t.redirect("/");t.render("account/forgot",{title:"パスワードをお忘れの方へ"})}),t.postForgot=((e,t,r)=>{e.assert("email","有効なメールアドレスを入力してください.").isEmail(),e.sanitize("email").normalizeEmail({gmail_remove_dots:!1});const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("/forgot");d(16).then(e=>e.toString("hex")).then(t=>u.default.findOne({email:e.body.email}).then(r=>(r?(r.passwordResetToken=t,r.passwordResetExpires=Date.now()+36e5,r=r.save()):e.flash("errors",{msg:"このメールアドレスのアカウントは存在しません."}),r))).then(t=>{if(!t)return;const r=t.passwordResetToken;let s=n.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD}});const o={to:t.email,from:"crypto@pay.com",subject:"Crypto Payのパスワードリセット",text:`You are receiving this email because you (or someone else) have requested the reset of the password for your account.\n\n\n        Please click on the following link, or paste this into your browser to complete the process:\n\n\n        http://${e.headers.host}/reset/${r}\n\n\n        If you did not request this, please ignore this email and your password will remain unchanged.\n`};return s.sendMail(o).then(()=>{e.flash("info",{msg:`An e-mail has been sent to ${t.email} with further instructions.`})}).catch(r=>"self signed certificate in certificate chain"===r.message?(console.log("WARNING: Self signed certificate in certificate chain. Retrying with the self signed certificate. Use a valid certificate if in production."),(s=n.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD},tls:{rejectUnauthorized:!1}})).sendMail(o).then(()=>{e.flash("info",{msg:`An e-mail has been sent to ${t.email} with further instructions.`})})):(console.log("ERROR: Could not send forgot password email after security downgrade.\n",r),e.flash("errors",{msg:"Error sending the password reset message. Please try again shortly."}),r))}).then(()=>t.redirect("/forgot")).catch(r)}),t.getReset=((e,t,r)=>{if(e.isAuthenticated())return t.redirect("/");u.default.findOne({passwordResetToken:e.params.token}).where("passwordResetExpires").gt(Date.now()).exec((s,o)=>s?r(s):o?void t.render("account/reset",{title:"パスワードリセット"}):(e.flash("errors",{msg:"パスワードリセットトークンが無効か期限切れです."}),t.redirect("/forgot")))}),t.postReset=((e,t,r)=>{e.assert("password","パスワードは4文字以上にしてください.").len({min:4}),e.assert("confirm","パスワードが一致しません.").equals(e.body.password);const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("back");(()=>u.default.findOne({passwordResetToken:e.params.token}).where("passwordResetExpires").gt(Date.now()).then(r=>r?(r.password=e.body.password,r.passwordResetToken=void 0,r.passwordResetExpires=void 0,r.save().then(()=>new Promise((t,s)=>{e.logIn(r,e=>{if(e)return s(e);t(r)})}))):(e.flash("errors",{msg:"パスワードリセットトークンが無効か期限切れです."}),t.redirect("back"))))().then(t=>{if(!t)return;let r=n.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD}});const s={to:t.email,from:"test@example.com",subject:"Crypto Payのパスワードを変更しました.",text:`Hello,\n\nThis is a confirmation that the password for your account ${t.email} has just been changed.\n`};return r.sendMail(s).then(()=>{e.flash("success",{msg:"パスワード変更に成功しました."})}).catch(t=>"self signed certificate in certificate chain"===t.message?(console.log("WARNING: Self signed certificate in certificate chain. Retrying with the self signed certificate. Use a valid certificate if in production."),(r=n.default.createTransport({service:"SendGrid",auth:{user:process.env.SENDGRID_USER,pass:process.env.SENDGRID_PASSWORD},tls:{rejectUnauthorized:!1}})).sendMail(s).then(()=>{e.flash("success",{msg:"パスワード変更に成功しました."})})):(console.log("ERROR: Could not send password reset confirmation email after security downgrade.\n",t),e.flash("warning",{msg:"Your password has been changed, however we were unable to send you a confirmation email. We will be looking into it shortly."}),t))}).then(()=>{t.finished||t.redirect("/")}).catch(e=>r(e))}),t.getAccount=((e,t)=>{t.render("account/profile",{title:"Account Management"})}),t.postUpdateProfile=((e,t,r)=>{e.assert("email","有効なメールアドレスを入力してください.").isEmail(),e.sanitize("email").normalizeEmail({gmail_remove_dots:!1});const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("/account");u.default.findById(e.user.id,(s,o)=>{if(s)return r(s);o.email=e.body.email||"",o.profile.name=e.body.name||"",o.profile.gender=e.body.gender||"",o.profile.location=e.body.location||"",o.profile.website=e.body.website||"",o.save(s=>{if(s)return 11e3===s.code?(e.flash("errors",{msg:"入力されたメールアドレスはすでに存在しています."}),t.redirect("/account")):r(s);e.flash("success",{msg:"プロフィール情報を更新しました."}),t.redirect("/account")})})}),t.postUpdatePassword=((e,t,r)=>{e.assert("password","パスワードは4文字以上にしてください.").len({min:4}),e.assert("confirmPassword","パスワードが一致しません.").equals(e.body.password);const s=e.validationErrors();if(s)return e.flash("errors",s),t.redirect("/account");u.default.findById(e.user.id,(s,o)=>{if(s)return r(s);o.password=e.body.password,o.save(s=>{if(s)return r(s);e.flash("success",{msg:"パスワードを変更しました."}),t.redirect("/account")})})}),t.postDeleteAccount=((e,t,r)=>{u.default.deleteOne({_id:e.user.id},s=>{if(s)return r(s);e.logout(),e.flash("info",{msg:"アカウントを削除しました."}),t.redirect("/")})}),t.getOauthUnlink=((e,t,r)=>{const{provider:s}=e.params;u.default.findById(e.user.id,(o,n)=>{if(o)return r(o);n[s]=void 0,n.tokens=n.tokens.filter(e=>e.kind!==s),n.save(o=>{if(o)return r(o);e.flash("info",{msg:`${s}アカウントとの連携を解除しました.`}),t.redirect("/account")})})})},function(e,t){e.exports=require("util")},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(0)),n=new o.default.Schema({name:String,customerCount:Number}),i=o.default.model("Count",n);t.default=i},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(r(1)),n=s(r(30)),i=s(r(31)),a=s(r(32)),u=s(r(33)),l=s(r(2)),c=n.default.Strategy,d=i.default.Strategy,f=a.default.Strategy;o.default.serializeUser((e,t)=>{t(void 0,e.id)}),o.default.deserializeUser((e,t)=>{l.default.findById(e,(e,r)=>{t(e,r)})}),o.default.use(new c({usernameField:"email"},(e,t,r)=>{l.default.findOne({email:e.toLowerCase()},(s,o)=>s?r(s):o?void o.comparePassword(t,(e,t)=>e?r(e):t?r(void 0,o):r(void 0,!1,{message:"Invalid email or password."})):r(void 0,!1,{message:`Email ${e} not found.`}))})),o.default.use(new d({clientID:process.env.FACEBOOK_ID,clientSecret:process.env.FACEBOOK_SECRET,callbackURL:"/auth/facebook/callback",profileFields:["name","email","link","locale","timezone","gender"],passReqToCallback:!0},(e,t,r,s,o)=>{e.user?l.default.findOne({facebook:s.id},(r,n)=>{if(r)return o(r);n?(e.flash("errors",{msg:"There is already a Facebook account that belongs to you. Sign in with that account or delete it, then link it with your current account."}),o(r)):l.default.findById(e.user.id,(r,n)=>{if(r)return o(r);n.facebook=s.id,n.tokens.push({kind:"facebook",accessToken:t}),n.profile.name=n.profile.name||`${s.name.givenName} ${s.name.familyName}`,n.profile.gender=n.profile.gender||s._json.gender,n.profile.picture=n.profile.picture||`https://graph.facebook.com/${s.id}/picture?type=large`,n.save(t=>{e.flash("info",{msg:"Facebook account has been linked."}),o(t,n)})})}):l.default.findOne({facebook:s.id},(r,n)=>r?o(r):n?o(void 0,n):void l.default.findOne({email:s._json.email},(r,n)=>{if(r)return o(r);if(n)e.flash("errors",{msg:"There is already an account using this email address. Sign in to that account and link it with Facebook manually from Account Settings."}),o(r);else{const e=new l.default;e.email=s._json.email,e.facebook=s.id,e.tokens.push({kind:"facebook",accessToken:t}),e.profile.name=`${s.name.givenName} ${s.name.familyName}`,e.profile.gender=s._json.gender,e.profile.picture=`https://graph.facebook.com/${s.id}/picture?type=large`,e.profile.location=s._json.location?s._json.location.name:"",e.save(t=>{o(t,e)})}}))})),o.default.use(new f({consumerKey:process.env.TWITTER_KEY,consumerSecret:process.env.TWITTER_SECRET,callbackURL:"/auth/twitter/callback",passReqToCallback:!0},(e,t,r,s,o)=>{e.user?l.default.findOne({twitter:s.id},(n,i)=>{if(n)return o(n);i?(e.flash("errors",{msg:"There is already a Twitter account that belongs to you. Sign in with that account or delete it, then link it with your current account."}),o(n)):l.default.findById(e.user.id,(n,i)=>{if(n)return o(n);i.twitter=s.id,i.tokens.push({kind:"twitter",accessToken:t,tokenSecret:r}),i.profile.name=i.profile.name||s.displayName,i.profile.location=i.profile.location||s._json.location,i.profile.picture=i.profile.picture||s._json.profile_image_url_https,i.save(t=>{if(t)return o(t);e.flash("info",{msg:"Twitter account has been linked."}),o(t,i)})})}):l.default.findOne({twitter:s.id},(e,n)=>{if(e)return o(e);if(n)return o(void 0,n);const i=new l.default;i.email=`${s.username}@twitter.com`,i.twitter=s.id,i.tokens.push({kind:"twitter",accessToken:t,tokenSecret:r}),i.profile.name=s.displayName,i.profile.location=s._json.location,i.profile.picture=s._json.profile_image_url_https,i.save(e=>{o(e,i)})})})),t.isAuthenticated=((e,t,r)=>{if(e.isAuthenticated())return r();t.redirect("/login")}),t.isAuthorized=((e,t,r)=>{const s=e.path.split("/").slice(-1)[0];u.default.find(e.user.tokens,{kind:s})?r():t.redirect(`/auth/${s}`)})},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("passport-facebook")},function(e,t){e.exports=require("passport-twitter")},function(e,t){e.exports=require("lodash")}]);